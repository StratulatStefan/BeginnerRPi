{% extends 'base.html' %}
{% block content %}
    <h3 class="title">Etilotest</h3>
    <h3>In acelasi stil prezentat anterior, vom construi un etilotest. </h3>
    <h3>Etilotestul este un dispozitiv care masoara nivelul de alcool din aerul respirat.</h3>
    <h3>Instructiuni : Persoana trebuie sa fie la o distanta mica de senzor. In acest sens,
        un senzor va masura distanta persoanei fata de dispozitiv si va oferi un feedback.
        Dupa ce primeste confirmare din partea sistemului, tinand apasat incontinuu butonul de masurare,
        persoana sufla in senzor cat timp va fi indicat de sistem prin intermediul unui cronometru.
        Rezultatul va fi afisat ulterior pe ecran</h3>
    <h3>Elementele folosite pentru acest sistem sunt urmatoarele : </h3>
    <hr />
    <ol>
        <li>Senzor ultrasonic pentru masurarea distantei (HC-SR04) : Va masura distanta persoanei fata de dispozitiv</li>
        <li>Senzor de masurare a nivelului de alcool din aerul respirat (MQ3)</li>
    </ol>
    <hr />

    <button onclick="EtilotestSequence()">Pornire secventa masurare</button>
    <div id="alcool">
        <h3>Pasi de urmat</h3>
        <ol>
	    <li>Pentru a porni secventa de masurare, trebuie sa ne asiguram ca sunteti langa senzor.<br/>
            </li>
            <h3>Luati cartela de pe masa si mentineti-o aproape de senzor timp de 7 perioade de masurare!</h3>
	    <h3 id="distanta"></h3>
            <h3 id="distanta_cartela" style="color:red;">Astept apropierea cartelei...</h3>
            <h3 id="cronometru"></h3>
        </ol>
    </div>
    <script>
         var cronometru = 7;
         
         function EtilotestSequence(){
    	     var alcool = document.getElementById("alcool");
             alcool.style.display = "block";
             distanceCheck = setInterval(getDistance, 1000); 
	     }

         async function getDistance(){
             var response = await fetch('/distantacartela')
             var distance = await response.json()
             console.log(distance);
             distance = parseFloat(distance.distanta).toFixed(2)
             
             if(distance > 20){
var cartela = document.getElementById("distanta_cartela")
                    cartela.style.color = "red";
                    cartela.innerHTML = "Astept apropierea cartelei..."
	         document.getElementById("distanta").innerHTML = "Distanta : prea mare [peste 20 cm]"
             cronometru = 7
             document.getElementById("cronometru").innerHTML = `Cronometru : ${cronometru} perioade`
	     }
	     else{

                    var cartela = document.getElementById("distanta_cartela")
                    cartela.style.color = "green";
                 document.getElementById("distanta").innerHTML = `Distanta : ${distance} cm`
                 cronometru -= 1;
             document.getElementById("cronometru").innerHTML = `Cronometru : ${cronometru} perioade`
cartela.innerHTML = "Am detectat cartela. Continuati sa o mentineti!"
                 if(cronometru == 0){
                    cartela.innerHTML = "Cartela detectata!"
            document.getElementById("cronometru").style.display = "none"
document.getElementById("distanta").style.display = "none"
                    clearInterval(distanceCheck);
                }
                 
             } 
	}
    </script>
{% endblock %}

